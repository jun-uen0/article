# ECS Fargateを立ち上げる

## 環境 / 前提
AWSアカウント
ECRにイメージがある状態

## ECR イメージの準備
こちらの記事を参考にしてください。
[DockerイメージをAWS ECRにプッシュする](https://zenn.dev/jun_uen0/articles/c57cbf45b2bf2a) 

## ECSについて
AWSのDockerコンテナサービスです。
調べるとさまざまな解釈で説明がされています。初心者の方にとっては初めての概念、用語が出てきて理解に時間がかかります。
一度、本記事を通して起動確認まで行ってから、じっくりと調べていただくことをお勧めします。

この3つの用語だけは外せないので紹介します。
- タスク/タスク定義: コンテナの設定を行います。
- サービス: タスクの割り当て、オートスケーリングの設定や、VPCなどの設定を行います。
- クラスター: サービスの集合体です。

## 手順
1. タスク定義の作成
2. クラスターの作成
3. サービスの作成

## ECSクラスターの作成
> ECSクラスターとはタスクを配置する「EC2インスタンス群」のことです。ただし、どのEC2インスタンスで起動しているかが隠蔽されているため、SSH接続して操作することができません。
1.  ECSダッシュボードから「クラスターの作成　」を選択
2.  ネットワーキングのみ(Fargateを使用)を選択
3.  クラスターに名前を付ける
4.  VPCを作成 (任意)
5.  作成

※ 作成完了まで2分程度待ちます。


## ECSタスク定義の作成
> タスクはDockerコンテナに相当します。どのようにタスクを起動するかを設定します。つまり `docker-compose.yml` のようなものです。JSON形式で設定されます。
1. ECSダッシュボードから「タスク定義」を選択
2. 「新しいタスク定義の作成」を選択
3. 「FARGATE」を選択
4. タスク定義名を記入
5. タスクロールは「ecsTaskExecution」(デフォルト)
6. オペレーティングシステムファミリー：「Linux」
7. タスクメモリ：任意のメモリ
8. タスクCPU：任意のCPU
  9. コンテナの追加
    1. コンテナ名：任意のコンテナ名
    2. イメージ：ECRのURIをコピー (タグは  `:latest` )
    3. あとは空欄のまま「追加」
10. 作成


## ECSサービスの作成
> ECSサービスとはサービスは、ALBとAutoScaling Groupに紐付けられた「**タスク群**」です。サービスの作成時にタスク定義を付与する必要がありますが、**サービスはタスクの上位概念というわけではありません**。タスクはタスク単体でECSクラスターへ配置することができるからです。

- サービスの設定
1. ECSダッシュボードから「クラスター」を選択
2.  作成したクラスターを選択しダッシュボードを表示
3. 一番左のタブの「サービス」を選択
4. 「作成」を選択
6. タスク定義： 「タスク定義の作成」で作成したタスク定義を選択
7. リビジョン：「〇〇 (latest)」
8. サービス名：任意のサービス名
9. タスクの数：「1」
10. その他の項目は初期値のまま


- ネットワーク構成
11. クラスター VPC：任意のVPCを選択 (1つだけ)
12. サブネット：必要な分だけ選択
13. セキュリティグループ：任意のセキュリティグループ
14. パブリック IP の自動割り当て：「ENABLE」(デフォルト)
15. 一部の設定を除いてロードバランサーは選べません


- Auto Scaling (オプション)
16. サービスの必要数を直接調整しない



⇒ 全項目を確認後、「サービスの作成」


##  ECSの起動確認
1. ECSダッシュボードから「クラスター」を選択
2.  作成したクラスターを選択しダッシュボードを表示
3. 左からの2番目のタブの「タスク」を選択
4. RUNNING中のタスク名をクリック (一番左)
5. 画面中央の「ネットワーク」のパブリックIPで起動確認を行えます (※パブリックIPはECRのイメージが更新されると変わってしまいます)


**ログの確認**
1.  上記起動確認の 1 ~ 4「RUNNING中のタスク名をクリック (一番左)」まで同じ
2. タブの一番右にある「ログ」で確認を行えます。





# ECRを使用せず、Docker Hubのイメージを使用する
実はECRにイメージがなくとも、ECS Fargateの起動確認はできます。
今回の記事でわざわざECRにイメージを用意したのは、実際の運用で必ず必要となるからです。

ECRを参照せずにFargateを立ち上げる方法というのはDocker Hubにある